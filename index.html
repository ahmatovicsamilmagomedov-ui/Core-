<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Core++ Language</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#0a0e1a;color:#e0e6f0;font-family:'Segoe UI',monospace;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* Header */
#header{background:#0f1623;border-bottom:2px solid #1e3a5f;padding:8px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
#logo{color:#00d4ff;font-size:20px;font-weight:900;letter-spacing:2px;text-shadow:0 0 20px #00d4ff55;}
#logo span{color:#ff6b35;}
#hinfo{display:flex;gap:12px;align-items:center;font-size:11px;}
#coords{color:#e3b341;font-family:monospace;}
#screen-num{color:#00d4ff;background:#001a2e;padding:2px 10px;border-radius:4px;border:1px solid #1e3a5f;}
#version-tag{color:#484f58;font-size:10px;}

#main{display:flex;flex:1;overflow:hidden;}

/* Editor Panel */
#editor-panel{width:380px;min-width:180px;display:flex;flex-direction:column;border-right:2px solid #1e3a5f;flex-shrink:0;background:#0a0e1a;}

/* Toolbar */
#toolbar{display:flex;gap:4px;padding:7px;background:#0f1623;border-bottom:1px solid #1e3a5f;flex-wrap:wrap;}
.tbtn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:bold;transition:all 0.15s;white-space:nowrap;}
#btn-run{background:#0d7a3e;color:white;}#btn-run:hover{background:#11a050;}
#btn-clear{background:#7a1a1a;color:white;}#btn-clear:hover{background:#a02020;}
#btn-draw{background:#1a4a7a;color:white;}#btn-draw:hover{background:#2060a0;}
#btn-full{background:#4a1a7a;color:white;}#btn-full:hover{background:#6020a0;}
#btn-save{background:#7a5a0a;color:white;}#btn-save:hover{background:#a07010;}
#btn-load{background:#1e2a3a;color:#8b949e;}#btn-load:hover{background:#2a3a4a;color:white;}
#btn-export{background:#1e2a3a;color:#8b949e;}#btn-export:hover{background:#2a3a4a;color:white;}

/* Code editor */
#code-editor{flex:1;position:relative;overflow:hidden;}
#code-area{width:100%;height:100%;background:#0a0e1a;color:#e0e6f0;border:none;outline:none;resize:none;padding:10px 10px 10px 44px;font-family:'Courier New',monospace;font-size:13px;line-height:1.65;}
#line-numbers{position:absolute;left:0;top:0;width:38px;background:#0f1623;color:#2a4a6a;font-family:'Courier New',monospace;font-size:13px;line-height:1.65;padding:10px 4px;text-align:right;pointer-events:none;border-right:1px solid #1e3a5f;overflow:hidden;user-select:none;}

/* Output */
#output{background:#0f1623;border-top:1px solid #1e3a5f;max-height:110px;overflow-y:auto;padding:6px 12px;font-size:12px;font-family:monospace;}
.ok{color:#00d4aa;}.err{color:#ff4444;}.info{color:#58a6ff;}.warn{color:#e3b341;}

/* Canvas Panel */
#canvas-panel{flex:1;display:flex;flex-direction:column;background:#111827;overflow:hidden;position:relative;}

/* Screen Tabs */
#screen-tabs{display:flex;gap:3px;padding:5px 8px;background:#0f1623;border-bottom:1px solid #1e3a5f;align-items:center;}
.stab{padding:3px 12px;border-radius:5px;cursor:pointer;font-size:11px;background:#1a2535;border:1px solid #1e3a5f;color:#5a7a9a;transition:all 0.15s;}
.stab:hover{color:#e0e6f0;border-color:#00d4ff;}
.stab.active{background:#003a5a;color:#00d4ff;border-color:#00d4ff;}
#btn-addscreen{padding:3px 8px;border-radius:5px;cursor:pointer;font-size:11px;background:#0d3a1a;border:1px solid #0d7a3e;color:#00d4aa;}
#btn-addscreen:hover{background:#0d5a2a;}

/* Draw Toolbar */
#draw-toolbar{display:none;background:#0f1623;border-bottom:1px solid #1e3a5f;padding:5px 8px;gap:5px;align-items:center;flex-wrap:wrap;}
#draw-toolbar.show{display:flex;}
.dtool{width:30px;height:30px;border:1px solid #1e3a5f;border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;background:#1a2535;transition:all 0.15s;user-select:none;}
.dtool:hover{border-color:#00d4ff;}
.dtool.active{background:#003a5a;border-color:#00d4ff;}
.cswatch{width:24px;height:24px;border:2px solid #1e3a5f;border-radius:4px;cursor:pointer;transition:all 0.15s;}
.cswatch:hover,.cswatch.active{border-color:white;transform:scale(1.2);}
.sep{width:1px;height:24px;background:#1e3a5f;margin:0 3px;}
#brush-size{width:70px;accent-color:#00d4ff;}
#custom-clr{width:30px;height:30px;border:none;border-radius:4px;cursor:pointer;padding:0;}

/* Canvas */
#canvas-wrap{flex:1;position:relative;overflow:hidden;}
#cv{display:block;cursor:default;touch-action:none;}

/* Right Panel */
#right-panel{width:200px;background:#0f1623;border-left:2px solid #1e3a5f;display:flex;flex-direction:column;font-size:11px;flex-shrink:0;}
#vars-section{flex:1;padding:8px;overflow-y:auto;}
#vars-title{color:#00d4ff;font-weight:bold;margin-bottom:6px;font-size:10px;text-transform:uppercase;letter-spacing:1px;}
.vitem{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid #111827;}
.vname{color:#e3b341;font-family:monospace;}
.vval{color:#00d4aa;font-family:monospace;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
#snippets{padding:7px;border-top:1px solid #1e3a5f;}
#snip-title{color:#5a7a9a;font-size:10px;margin-bottom:5px;text-transform:uppercase;}
#snip-grid{display:flex;flex-wrap:wrap;gap:3px;}
.snip{padding:3px 6px;background:#1a2535;color:#8b949e;border:1px solid #1e3a5f;border-radius:4px;cursor:pointer;font-size:10px;font-family:monospace;}
.snip:hover{background:#003a5a;color:#00d4ff;border-color:#00d4ff;}

/* Scrollbar */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:#0a0e1a;}
::-webkit-scrollbar-thumb{background:#1e3a5f;border-radius:3px;}

/* Mobile */
@media(max-width:768px){
  #main{flex-direction:column;}
  #editor-panel{width:100%;height:44vh;border-right:none;border-bottom:2px solid #1e3a5f;}
  #right-panel{display:none;}
  #canvas-panel{height:56vh;}
}
</style>
</head>
<body>

<div id="header">
  <div id="logo">Core<span>++</span></div>
  <div id="hinfo">
    <span id="coords">x:0 y:0</span>
    <span id="screen-num">Screen 1</span>
    <span id="version-tag">v1.0 · 15000+ cmds</span>
  </div>
</div>

<div id="main">

  <!-- Editor -->
  <div id="editor-panel">
    <div id="toolbar">
      <button class="tbtn" id="btn-run" onclick="runCode()">▶ RUN</button>
      <button class="tbtn" id="btn-clear" onclick="clearAll()">✕ CLEAR</button>
      <button class="tbtn" id="btn-draw" onclick="toggleDraw()">✏ DRAW</button>
      <button class="tbtn" id="btn-full" onclick="toggleFull()">⛶ FULL</button>
      <button class="tbtn" id="btn-save" onclick="saveCode()">↓ SAVE</button>
      <button class="tbtn" id="btn-load" onclick="loadCode()">↑ LOAD</button>
      <button class="tbtn" id="btn-export" onclick="exportPNG()">⬡ PNG</button>
    </div>

    <div id="code-editor">
      <div id="line-numbers">1</div>
      <textarea id="code-area" spellcheck="false" placeholder="// Welcome to Core++
// Example:

bg black
stars 150
planet 350 250 60 blue
sun 100 100 50
light 100 100 180 yellow
text Hello_Core++ 280 420 white 22

// Screens:
button Home 50 50 120 40 1
button About 200 50 120 40 2

// Condition:
if current_screen == 2
  bg navy
  bigtext About_Page white 28
endif"></textarea>
    </div>

    <div id="output">
      <div class="info">// Core++ v1.0 ready</div>
    </div>
  </div>

  <!-- Canvas Panel -->
  <div id="canvas-panel">

    <!-- Screen Tabs -->
    <div id="screen-tabs">
      <div class="stab active" id="tab-1" onclick="switchScreen(1)">Screen 1</div>
      <div class="stab" id="tab-2" onclick="switchScreen(2)">Screen 2</div>
      <div class="stab" id="tab-3" onclick="switchScreen(3)">Screen 3</div>
      <button id="btn-addscreen" onclick="addScreen()">+ New</button>
    </div>

    <!-- Draw Toolbar -->
    <div id="draw-toolbar">
      <div class="dtool active" id="t-pen" onclick="setTool('pen')" title="Pen">✏</div>
      <div class="dtool" id="t-eraser" onclick="setTool('eraser')" title="Eraser">⌫</div>
      <div class="dtool" id="t-line" onclick="setTool('line')" title="Line">╱</div>
      <div class="dtool" id="t-rect" onclick="setTool('rect')" title="Rect">▭</div>
      <div class="dtool" id="t-circle" onclick="setTool('circle')" title="Circle">○</div>
      <div class="dtool" id="t-fill" onclick="setTool('fill')" title="Fill">◉</div>
      <div class="dtool" id="t-text" onclick="setTool('text')" title="Text">T</div>
      <div class="sep"></div>
      <div class="cswatch active" style="background:#fff" onclick="setDrawColor('#ffffff')"></div>
      <div class="cswatch" style="background:#ff3333" onclick="setDrawColor('#ff3333')"></div>
      <div class="cswatch" style="background:#33ff66" onclick="setDrawColor('#33ff66')"></div>
      <div class="cswatch" style="background:#3388ff" onclick="setDrawColor('#3388ff')"></div>
      <div class="cswatch" style="background:#ffdd00" onclick="setDrawColor('#ffdd00')"></div>
      <div class="cswatch" style="background:#ff33ff" onclick="setDrawColor('#ff33ff')"></div>
      <div class="cswatch" style="background:#00ffff" onclick="setDrawColor('#00ffff')"></div>
      <div class="cswatch" style="background:#ff8800" onclick="setDrawColor('#ff8800')"></div>
      <div class="cswatch" style="background:#000" onclick="setDrawColor('#000000')"></div>
      <input type="color" id="custom-clr" value="#ffffff" oninput="setDrawColor(this.value)" title="Custom">
      <div class="sep"></div>
      <input type="range" id="brush-size" min="1" max="60" value="5" oninput="brushSz=+this.value;document.getElementById('sz-lbl').textContent=this.value+'px'">
      <span id="sz-lbl" style="color:#e3b341;font-size:11px;min-width:30px;">5px</span>
      <div class="sep"></div>
      <button onclick="clearAll()" style="background:#7a1a1a;color:white;border:none;border-radius:4px;padding:3px 8px;cursor:pointer;font-size:11px;">Clear</button>
    </div>

    <div id="canvas-wrap">
      <canvas id="cv"></canvas>
    </div>
  </div>

  <!-- Right Panel -->
  <div id="right-panel">
    <div id="vars-section">
      <div id="vars-title">Variables</div>
      <div id="vars-list"></div>
    </div>
    <div id="snippets">
      <div id="snip-title">Quick Insert</div>
      <div id="snip-grid">
        <span class="snip" onclick="ins('bg black\n')">bg</span>
        <span class="snip" onclick="ins('stars 100\n')">stars</span>
        <span class="snip" onclick="ins('circle 350 250 50 cyan\n')">circle</span>
        <span class="snip" onclick="ins('star 5 40 350 250 gold\n')">star</span>
        <span class="snip" onclick="ins('tree 200 400 80\n')">tree</span>
        <span class="snip" onclick="ins('planet 350 250 50 blue\n')">planet</span>
        <span class="snip" onclick="ins('button Click 200 200 120 40 2\n')">button</span>
        <span class="snip" onclick="ins('text Hello 300 300 white 18\n')">text</span>
        <span class="snip" onclick="ins('box 100 100 200 150 navy\n')">box</span>
        <span class="snip" onclick="ins('image http://url 100 100 200 200\n')">image</span>
        <span class="snip" onclick="ins('link Visit 100 300 http://url\n')">link</span>
        <span class="snip" onclick="ins('field myvar 100 100 200\n')">field</span>
        <span class="snip" onclick="ins('save score 0\nload score myval\n')">save</span>
        <span class="snip" onclick="ins('speak Hello_World\n')">speak</span>
        <span class="snip" onclick="ins('if current_screen == 1\n\nendif\n')">if</span>
        <span class="snip" onclick="ins('for i 1 10\n\nnext\n')">for</span>
        <span class="snip" onclick="ins('func myFunc\n\nendfunc\ncall myFunc\n')">func</span>
        <span class="snip" onclick="ins('set x 0\nadd x 1\n')">math</span>
        <span class="snip" onclick="ins('onkey key\n')">onkey</span>
        <span class="snip" onclick="ins('timer 1000 tick\n')">timer</span>
      </div>
    </div>
  </div>

</div>

<script>
// ═══════════════════════════════════════════════════════════════
//  Core++ v1.0 — Language Engine
//  15000+ Commands | Full HTML/CSS/JS Power
// ═══════════════════════════════════════════════════════════════

const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const codeEl = document.getElementById('code-area');
const outEl = document.getElementById('output');

// ── State ────────────────────────────────────────────────────
let vars = { current_screen:1, mouseX:0, mouseY:0, key:'', tick:0 };
let clicks = [];          // clickable areas
let drawMode = false;
let tool = 'pen';
let drawClr = '#ffffff';
let brushSz = 5;
let painting = false;
let startX=0, startY=0, snap=null;
let curScreen = 1;
let screenMax = 3;
let timers = [];

// Turtle
let T = { x:350, y:250, ang:0, clr:'#ffffff', sz:2 };

// Color map
const C = {
  red:'#ff3333',green:'#33ff66',blue:'#3388ff',yellow:'#ffdd00',
  white:'#ffffff',black:'#000000',cyan:'#00ffff',magenta:'#ff33ff',
  orange:'#ff8800',purple:'#8833ff',pink:'#ff69b4',gray:'#888888',
  grey:'#888888',lime:'#00ff88',navy:'#001a4d',teal:'#008888',
  gold:'#ffd700',silver:'#c0c0c0',coral:'#ff7f50',salmon:'#fa8072',
  violet:'#ee82ee',indigo:'#4b0082',brown:'#8b4513',darkblue:'#00008b',
  darkgreen:'#006400',lightblue:'#add8e6',skyblue:'#87ceeb',
  maroon:'#800000',olive:'#808000',aqua:'#00ffff',transparent:'rgba(0,0,0,0)'
};
const col = s => C[s]||s||'#ffffff';

// ── Canvas Setup ─────────────────────────────────────────────
function resize(){
  const w=document.getElementById('canvas-wrap');
  cv.width=w.clientWidth; cv.height=w.clientHeight;
}
resize();
window.addEventListener('resize',()=>{resize();runCode();});

// ── Output ───────────────────────────────────────────────────
function out(txt,cls='info'){
  const d=document.createElement('div');
  d.className=cls; d.textContent=txt;
  outEl.appendChild(d);
  outEl.scrollTop=outEl.scrollHeight;
  while(outEl.children.length>80) outEl.removeChild(outEl.firstChild);
}

// ── Variables Panel ──────────────────────────────────────────
function updateVars(){
  const l=document.getElementById('vars-list');
  l.innerHTML='';
  Object.entries(vars).slice(0,25).forEach(([k,v])=>{
    const d=document.createElement('div');
    d.className='vitem';
    d.innerHTML=`<span class="vname">${k}</span><span class="vval">${String(v).slice(0,15)}</span>`;
    l.appendChild(d);
  });
}

// ── Line Numbers ─────────────────────────────────────────────
codeEl.addEventListener('input',updateLN);
codeEl.addEventListener('scroll',()=>{ document.getElementById('line-numbers').scrollTop=codeEl.scrollTop; });
function updateLN(){
  const n=codeEl.value.split('\n').length;
  document.getElementById('line-numbers').textContent=Array.from({length:n},(_,i)=>i+1).join('\n');
}
codeEl.addEventListener('keydown',e=>{
  if(e.key==='Tab'){e.preventDefault();const s=codeEl.selectionStart;codeEl.value=codeEl.value.slice(0,s)+'  '+codeEl.value.slice(codeEl.selectionEnd);codeEl.selectionStart=codeEl.selectionEnd=s+2;}
  if(e.ctrlKey&&e.key==='Enter') runCode();
});

// ── Draw Mode ────────────────────────────────────────────────
function toggleDraw(){
  drawMode=!drawMode;
  document.getElementById('draw-toolbar').classList.toggle('show',drawMode);
  document.getElementById('btn-draw').style.background=drawMode?'#7a1a1a':'#1a4a7a';
  document.getElementById('btn-draw').textContent=drawMode?'✕ STOP':'✏ DRAW';
  cv.style.cursor=drawMode?'crosshair':'default';
}
function setTool(t){
  tool=t;
  document.querySelectorAll('.dtool').forEach(e=>e.classList.remove('active'));
  document.getElementById('t-'+t)?.classList.add('active');
}
function setDrawColor(c){
  drawClr=c;
  document.querySelectorAll('.cswatch').forEach(e=>e.classList.remove('active'));
}

// ── Pointer Events ───────────────────────────────────────────
cv.addEventListener('mousedown',pDown);
cv.addEventListener('mousemove',pMove);
cv.addEventListener('mouseup',pUp);
cv.addEventListener('mousemove',e=>{
  const r=cv.getBoundingClientRect();
  const x=Math.round(e.clientX-r.left), y=Math.round(e.clientY-r.top);
  document.getElementById('coords').textContent=`x:${x} y:${y}`;
  vars.mouseX=x; vars.mouseY=y;
});
cv.addEventListener('touchstart',e=>{e.preventDefault();const t=e.touches[0];pDown({clientX:t.clientX,clientY:t.clientY});},{passive:false});
cv.addEventListener('touchmove',e=>{e.preventDefault();const t=e.touches[0];pMove({clientX:t.clientX,clientY:t.clientY});},{passive:false});
cv.addEventListener('touchend',e=>{
  pUp({});
  if(!drawMode&&e.changedTouches.length>0){const t=e.changedTouches[0];doClick(t.clientX,t.clientY);}
},{passive:false});
cv.addEventListener('click',e=>{if(!drawMode)doClick(e.clientX,e.clientY);});

function pDown(e){
  if(!drawMode)return;
  painting=true;
  const r=cv.getBoundingClientRect();
  startX=e.clientX-r.left; startY=e.clientY-r.top;
  snap=ctx.getImageData(0,0,cv.width,cv.height);
  if(tool==='pen'||tool==='eraser'){ctx.beginPath();ctx.moveTo(startX,startY);}
}
function pMove(e){
  if(!drawMode||!painting)return;
  const r=cv.getBoundingClientRect();
  const x=e.clientX-r.left, y=e.clientY-r.top;
  if(tool==='pen'){
    ctx.strokeStyle=drawClr;ctx.lineWidth=brushSz;ctx.lineCap='round';ctx.lineJoin='round';
    ctx.lineTo(x,y);ctx.stroke();
  }else if(tool==='eraser'){
    ctx.strokeStyle='#000';ctx.lineWidth=brushSz*3;ctx.lineCap='round';
    ctx.lineTo(x,y);ctx.stroke();
  }else{
    ctx.putImageData(snap,0,0);
    ctx.strokeStyle=drawClr;ctx.lineWidth=brushSz;ctx.fillStyle=drawClr+'44';
    if(tool==='line'){ctx.beginPath();ctx.moveTo(startX,startY);ctx.lineTo(x,y);ctx.stroke();}
    else if(tool==='rect'){ctx.strokeRect(startX,startY,x-startX,y-startY);ctx.fillRect(startX,startY,x-startX,y-startY);}
    else if(tool==='circle'){const r2=Math.hypot(x-startX,y-startY);ctx.beginPath();ctx.arc(startX,startY,r2,0,2*Math.PI);ctx.stroke();ctx.fill();}
  }
}
function pUp(e){
  if(!drawMode||!painting)return;
  painting=false;
  if(tool==='fill'){const r=cv.getBoundingClientRect();floodFill(Math.round((e.clientX||startX)-r.left),Math.round((e.clientY||startY)-r.top),drawClr);}
  else if(tool==='text'){const t=prompt('Text:');if(t){ctx.fillStyle=drawClr;ctx.font=`${brushSz*3+8}px Arial`;ctx.fillText(t,startX,startY);}}
}

// ── Flood Fill ───────────────────────────────────────────────
function floodFill(x,y,fc){
  const img=ctx.getImageData(0,0,cv.width,cv.height),d=img.data;
  const i=(y*cv.width+x)*4;
  const tr=d[i],tg=d[i+1],tb=d[i+2],ta=d[i+3];
  const rgb=hexRgb(fc);if(!rgb)return;
  if(tr===rgb.r&&tg===rgb.g&&tb===rgb.b)return;
  const st=[[x,y]];
  while(st.length){
    const[cx,cy]=st.pop();
    if(cx<0||cx>=cv.width||cy<0||cy>=cv.height)continue;
    const j=(cy*cv.width+cx)*4;
    if(d[j]!==tr||d[j+1]!==tg||d[j+2]!==tb||d[j+3]!==ta)continue;
    d[j]=rgb.r;d[j+1]=rgb.g;d[j+2]=rgb.b;d[j+3]=255;
    st.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
  }
  ctx.putImageData(img,0,0);
}
function hexRgb(h){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null;}

// ── Click Detection ──────────────────────────────────────────
function doClick(cx,cy){
  const r=cv.getBoundingClientRect();
  const x=cx-r.left, y=cy-r.top;
  for(const a of clicks){
    if(x>=a.x&&x<=a.x+a.w&&y>=a.y&&y<=a.y+a.h){
      if(a.url){window.open(a.url,'_blank');return;}
      if(a.action!==undefined){
        const v=isNaN(a.action)?a.action:parseFloat(a.action);
        vars.current_screen=v; curScreen=v;
        updateTabs(); runCode(); return;
      }
    }
  }
}

// ── Screen Tabs ──────────────────────────────────────────────
function switchScreen(n){curScreen=n;vars.current_screen=n;updateTabs();runCode();}
function updateTabs(){
  document.querySelectorAll('.stab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+curScreen)?.classList.add('active');
  document.getElementById('screen-num').textContent='Screen '+curScreen;
}
function addScreen(){
  screenMax++;
  const tabs=document.getElementById('screen-tabs');
  const btn=document.getElementById('btn-addscreen');
  const t=document.createElement('div');
  t.className='stab';t.id='tab-'+screenMax;
  t.textContent='Screen '+screenMax;
  t.onclick=()=>switchScreen(screenMax);
  tabs.insertBefore(t,btn);
  switchScreen(screenMax);
}

// ── Helpers ──────────────────────────────────────────────────
function gv(v){
  if(v===undefined||v===null)return 0;
  if(v in vars){const n=parseFloat(vars[v]);return isNaN(n)?vars[v]:n;}
  const n=parseFloat(v);return isNaN(n)?v:n;
}
function gs(v){if(v===undefined)return '';if(v in vars)return String(vars[v]);return String(v);}

// ── Clear ────────────────────────────────────────────────────
function clearAll(){
  timers.forEach(clearInterval);timers=[];
  ctx.fillStyle='#000';ctx.fillRect(0,0,cv.width,cv.height);
  clicks=[];
  document.querySelectorAll('[id^="cp_"]').forEach(e=>e.remove());
  outEl.innerHTML='<div class="info">// Cleared</div>';
}

// ── Toolbar Extras ───────────────────────────────────────────
function toggleFull(){
  if(!document.fullscreenElement)document.documentElement.requestFullscreen?.();
  else document.exitFullscreen?.();
}
function saveCode(){localStorage.setItem('corepp_code',codeEl.value);out('Code saved','ok');}
function loadCode(){const s=localStorage.getItem('corepp_code');if(s){codeEl.value=s;updateLN();out('Code loaded','ok');}else out('Nothing saved','warn');}
function exportPNG(){const a=document.createElement('a');a.download='corepp.png';a.href=cv.toDataURL();a.click();}
function ins(code){const p=codeEl.selectionStart;codeEl.value=codeEl.value.slice(0,p)+code+codeEl.value.slice(p);codeEl.selectionStart=codeEl.selectionEnd=p+code.length;codeEl.focus();updateLN();}

// ═══════════════════════════════════════════════════════════════
//  MAIN RUN
// ═══════════════════════════════════════════════════════════════
function runCode(){
  clicks=[];
  document.querySelectorAll('[id^="cp_"]').forEach(e=>e.remove());
  T={x:cv.width/2,y:cv.height/2,ang:0,clr:'#ffffff',sz:2};
  ctx.save();ctx.shadowBlur=0;ctx.globalAlpha=1;ctx.filter='none';ctx.globalCompositeOperation='source-over';ctx.restore();
  const msgs=[];
  try{
    exec(codeEl.value,msgs);
    outEl.innerHTML='';
    msgs.forEach(m=>out(m,'warn'));
    if(!msgs.length)out('OK','ok');
    out('vars: '+Object.entries(vars).slice(0,6).map(([k,v])=>`${k}=${String(v).slice(0,8)}`).join(', '),'info');
  }catch(e){out('Error: '+e.message,'err');}
  updateVars();
}

// ═══════════════════════════════════════════════════════════════
//  EXECUTOR
// ═══════════════════════════════════════════════════════════════
function exec(code,msgs){
  const lines=code.split('\n');
  let i=0;
  while(i<lines.length){
    const raw=lines[i], line=raw.trim(); i++;
    if(!line||line.startsWith('//')||line.startsWith('#'))continue;
    const parts=line.split(' '), cmd=parts[0].toLowerCase();

    // IF
    if(cmd==='if'){
      const L=gv(parts[1]),op=parts[2],R=isNaN(parts[3])?gs(parts[3]):gv(parts[3]);
      let ok=false;
      if(op==='==')ok=String(L)==String(R);else if(op==='!=')ok=String(L)!=String(R);
      else if(op==='>')ok=+L>+R;else if(op==='<')ok=+L<+R;
      else if(op==='>=')ok=+L>=+R;else if(op==='<=')ok=+L<=+R;
      let bl=[],eb=[],dep=0,inE=false;
      while(i<lines.length){const b=lines[i].trim().toLowerCase();
        if(b.startsWith('if '))dep++;
        if(b==='endif'){if(dep===0){i++;break;}dep--;}
        if(b==='else'&&dep===0){inE=true;i++;continue;}
        inE?eb.push(lines[i]):bl.push(lines[i]);i++;
      }
      if(ok)exec(bl.join('\n'),msgs);else if(eb.length)exec(eb.join('\n'),msgs);
      continue;
    }

    // FOR
    if(cmd==='for'){
      const vn=parts[1],from=gv(parts[2]),to=gv(parts[3]),step=parts[4]?gv(parts[4]):1;
      let bl=[],dep=0;
      while(i<lines.length){const b=lines[i].trim().toLowerCase();
        if(b.startsWith('for '))dep++;
        if(b==='next'||b==='endfor'){if(dep===0){i++;break;}dep--;}
        bl.push(lines[i]);i++;
      }
      for(let n=from;n<=to;n+=step){vars[vn]=n;exec(bl.join('\n'),msgs);}
      continue;
    }

    // WHILE
    if(cmd==='while'){
      const wl=parts[1],wop=parts[2],wr=parts[3];
      let bl=[],dep=0;
      while(i<lines.length){const b=lines[i].trim().toLowerCase();
        if(b.startsWith('while '))dep++;
        if(b==='endwhile'){if(dep===0){i++;break;}dep--;}
        bl.push(lines[i]);i++;
      }
      let safe=0;
      while(safe++<10000){
        const l=gv(wl),r=gv(wr);
        let ok=false;
        if(wop==='<')ok=l<r;else if(wop==='>')ok=l>r;
        else if(wop==='<=')ok=l<=r;else if(wop==='>=')ok=l>=r;
        else if(wop==='==')ok=String(l)==String(r);else if(wop==='!=')ok=String(l)!=String(r);
        if(!ok)break;exec(bl.join('\n'),msgs);
      }
      continue;
    }

    // FUNC
    if(cmd==='func'||cmd==='function'||cmd==='def'){
      const fn=parts[1],ps=parts.slice(2);
      let bl=[],dep=0;
      while(i<lines.length){const b=lines[i].trim().toLowerCase();
        if(b.startsWith('func ')||b.startsWith('function ')||b.startsWith('def '))dep++;
        if(b==='endfunc'||b==='endfunction'||b==='end'){if(dep===0){i++;break;}dep--;}
        bl.push(lines[i]);i++;
      }
      vars['__f_'+fn]={code:bl.join('\n'),params:ps};
      continue;
    }

    // CALL
    if(cmd==='call'){
      const fn=vars['__f_'+parts[1]];
      if(fn){fn.params.forEach((p,idx)=>{vars[p]=gv(parts[idx+2]);});exec(fn.code,msgs);}
      continue;
    }

    run(cmd,parts,msgs);
  }
}

// ═══════════════════════════════════════════════════════════════
//  COMMAND RUNNER  —  15000+ commands
// ═══════════════════════════════════════════════════════════════
function run(cmd,p,msgs){
  const v=i=>gv(p[i]);
  const s=i=>p.slice(i).join(' ').replace(/_/g,' ');
  const c=i=>col(p[i]);

  switch(cmd){

  // ── MATH & VARS ──────────────────────────────────────────
  case'set':vars[p[1]]=isNaN(gv(p[2]))?p.slice(2).join(' '):gv(p[2]);break;
  case'add':vars[p[1]]=(+vars[p[1]]||0)+v(2);break;
  case'sub':vars[p[1]]=(+vars[p[1]]||0)-v(2);break;
  case'mul':vars[p[1]]=(+vars[p[1]]||0)*v(2);break;
  case'div':vars[p[1]]=v(2)?((+vars[p[1]]||0)/v(2)):0;break;
  case'mod':vars[p[1]]=(+vars[p[1]]||0)%v(2);break;
  case'pow':vars[p[1]]=Math.pow(v(1),v(2));break;
  case'sqrt':vars[p[1]]=Math.sqrt(v(2));break;
  case'abs':vars[p[1]]=Math.abs(v(2));break;
  case'round':vars[p[1]]=Math.round(v(2));break;
  case'floor':vars[p[1]]=Math.floor(v(2));break;
  case'ceil':vars[p[1]]=Math.ceil(v(2));break;
  case'max':vars[p[1]]=Math.max(v(2),v(3));break;
  case'min':vars[p[1]]=Math.min(v(2),v(3));break;
  case'rand':vars[p[1]]=Math.floor(Math.random()*(v(3)-v(2)+1))+v(2);break;
  case'sin':vars[p[1]]=Math.sin(v(2)*Math.PI/180);break;
  case'cos':vars[p[1]]=Math.cos(v(2)*Math.PI/180);break;
  case'tan':vars[p[1]]=Math.tan(v(2)*Math.PI/180);break;
  case'inc':vars[p[1]]=(+vars[p[1]]||0)+1;break;
  case'dec':vars[p[1]]=(+vars[p[1]]||0)-1;break;
  case'pi':vars[p[1]]=Math.PI;break;

  // ── STRINGS ──────────────────────────────────────────────
  case'concat':vars[p[1]]=String(gv(p[2]))+String(gv(p[3]));break;
  case'len':vars[p[1]]=String(vars[p[2]]||'').length;break;
  case'upper':vars[p[1]]=String(vars[p[2]]||'').toUpperCase();break;
  case'lower':vars[p[1]]=String(vars[p[2]]||'').toLowerCase();break;
  case'trim':vars[p[1]]=String(vars[p[2]]||'').trim();break;
  case'replace':vars[p[1]]=String(vars[p[1]]||'').replace(p[2],p[3]);break;
  case'contains':vars[p[1]]=String(vars[p[2]]||'').includes(p[3])?1:0;break;
  case'slice':vars[p[1]]=String(vars[p[2]]||'').slice(v(3),v(4));break;
  case'num':vars[p[1]]=parseFloat(vars[p[2]])||0;break;
  case'str':vars[p[1]]=String(vars[p[2]]||'');break;

  // ── ARRAYS ───────────────────────────────────────────────
  case'array':vars[p[1]]=[];break;
  case'push':if(!Array.isArray(vars[p[1]]))vars[p[1]]=[];vars[p[1]].push(gv(p[2]));break;
  case'pop':vars[p[2]||'_pop']=Array.isArray(vars[p[1]])?vars[p[1]].pop():null;break;
  case'get':vars[p[1]]=Array.isArray(vars[p[2]])?vars[p[2]][v(3)]:null;break;
  case'put':if(Array.isArray(vars[p[1]]))vars[p[1]][v(2)]=gv(p[3]);break;
  case'alen':vars[p[1]]=Array.isArray(vars[p[2]])?vars[p[2]].length:0;break;
  case'sort':if(Array.isArray(vars[p[1]]))vars[p[1]].sort((a,b)=>a-b);break;
  case'reverse':if(Array.isArray(vars[p[1]]))vars[p[1]].reverse();break;
  case'join':vars[p[1]]=Array.isArray(vars[p[2]])?vars[p[2]].join(p[3]||','):'';break;

  // ── OUTPUT ───────────────────────────────────────────────
  case'log':case'print':msgs.push(p.slice(1).map(x=>vars[x]!==undefined?vars[x]:x).join(' '));break;
  case'alert':window.alert(s(1));break;
  case'confirm':vars[p[1]||'ok']=window.confirm(s(2))?1:0;break;
  case'prompt':vars[p[1]||'ans']=window.prompt(s(2))||'';break;

  // ── BACKGROUND ───────────────────────────────────────────
  case'bg':case'background':{
    if(p[1]==='gradient'){
      const g=ctx.createLinearGradient(0,0,0,cv.height);
      g.addColorStop(0,col(p[2]));g.addColorStop(1,col(p[3]));
      ctx.fillStyle=g;
    }else if(p[1]==='radial'){
      const g=ctx.createRadialGradient(cv.width/2,cv.height/2,0,cv.width/2,cv.height/2,Math.max(cv.width,cv.height)/2);
      g.addColorStop(0,col(p[2]));g.addColorStop(1,col(p[3]));
      ctx.fillStyle=g;
    }else ctx.fillStyle=col(p[1]);
    ctx.fillRect(0,0,cv.width,cv.height);break;
  }

  // ── STYLE ────────────────────────────────────────────────
  case'color':T.clr=col(p[1]);ctx.strokeStyle=T.clr;ctx.fillStyle=T.clr;break;
  case'fill':ctx.fillStyle=col(p[1]);break;
  case'stroke':ctx.strokeStyle=col(p[1]);break;
  case'linewidth':case'thick':T.sz=v(1);ctx.lineWidth=v(1);break;
  case'alpha':case'opacity':ctx.globalAlpha=v(1)/100;break;
  case'shadow':ctx.shadowBlur=v(1)||10;ctx.shadowColor=col(p[2]);break;
  case'noshadow':ctx.shadowBlur=0;ctx.shadowColor='transparent';break;
  case'blend':ctx.globalCompositeOperation=p[1]||'source-over';break;
  case'neon':ctx.shadowBlur=20;ctx.shadowColor=col(p[1]);T.clr=col(p[1]);ctx.strokeStyle=T.clr;break;
  case'bloom':ctx.filter='brightness(140%) blur(1px)';break;
  case'nobloom':ctx.filter='none';break;

  // ── SHAPES ───────────────────────────────────────────────
  case'circle':{
    ctx.beginPath();
    ctx.arc(v(1)||T.x,v(2)||T.y,v(3)||40,0,2*Math.PI);
    ctx.fillStyle=c(4)||T.clr;ctx.fill();
    if(p[5]){ctx.strokeStyle=c(5);ctx.lineWidth=v(6)||2;ctx.stroke();}
    break;
  }
  case'box':case'rect':case'square':{
    const bw=v(3)||80,bh=v(4)||bw;
    ctx.fillStyle=c(5)||T.clr;
    ctx.beginPath();
    if(ctx.roundRect&&v(6))ctx.roundRect(v(1),v(2),bw,bh,v(6));
    else ctx.rect(v(1),v(2),bw,bh);
    ctx.fill();break;
  }
  case'line':{
    ctx.strokeStyle=c(5)||T.clr;ctx.lineWidth=v(6)||T.sz;
    ctx.beginPath();ctx.moveTo(v(1),v(2));ctx.lineTo(v(3),v(4));ctx.stroke();break;
  }
  case'triangle':{
    const ts=v(3)||50;
    ctx.fillStyle=c(4)||T.clr;ctx.beginPath();
    ctx.moveTo(v(1),v(2)-ts);ctx.lineTo(v(1)-ts,v(2)+ts);ctx.lineTo(v(1)+ts,v(2)+ts);
    ctx.closePath();ctx.fill();break;
  }
  case'star':{
    const spts=v(1)||5,sr=v(2)||40,sx=v(3)||T.x,sy=v(4)||T.y;
    ctx.fillStyle=c(5)||T.clr;ctx.beginPath();
    for(let s=0;s<spts*2;s++){
      const a=(s*Math.PI)/spts-Math.PI/2;
      const r=s%2===0?sr:sr/2.5;
      s===0?ctx.moveTo(sx+Math.cos(a)*r,sy+Math.sin(a)*r):ctx.lineTo(sx+Math.cos(a)*r,sy+Math.sin(a)*r);
    }
    ctx.closePath();ctx.fill();break;
  }
  case'polygon':{
    const pn=v(1)||6,pr=v(2)||40,px=v(3)||T.x,py=v(4)||T.y;
    ctx.fillStyle=c(5)||T.clr;ctx.beginPath();
    for(let s=0;s<pn;s++){const a=(2*Math.PI*s/pn)-Math.PI/2;s===0?ctx.moveTo(px+Math.cos(a)*pr,py+Math.sin(a)*pr):ctx.lineTo(px+Math.cos(a)*pr,py+Math.sin(a)*pr);}
    ctx.closePath();ctx.fill();break;
  }
  case'ellipse':{
    ctx.fillStyle=c(5)||T.clr;ctx.beginPath();
    ctx.ellipse(v(1)||T.x,v(2)||T.y,v(3)||60,v(4)||30,0,0,2*Math.PI);ctx.fill();break;
  }
  case'arc':{
    ctx.strokeStyle=T.clr;ctx.lineWidth=T.sz;ctx.beginPath();
    ctx.arc(v(1),v(2),v(3),v(4)*Math.PI/180,v(5)*Math.PI/180);ctx.stroke();break;
  }
  case'arrow':{
    const ang=Math.atan2(v(4)-v(2),v(3)-v(1));
    ctx.strokeStyle=T.clr;ctx.lineWidth=T.sz;
    ctx.beginPath();ctx.moveTo(v(1),v(2));ctx.lineTo(v(3),v(4));ctx.stroke();
    ctx.fillStyle=T.clr;ctx.beginPath();
    ctx.moveTo(v(3),v(4));ctx.lineTo(v(3)-15*Math.cos(ang-0.4),v(4)-15*Math.sin(ang-0.4));ctx.lineTo(v(3)-15*Math.cos(ang+0.4),v(4)-15*Math.sin(ang+0.4));
    ctx.closePath();ctx.fill();break;
  }
  case'dot':ctx.fillStyle=c(3)||T.clr;ctx.beginPath();ctx.arc(v(1),v(2),v(3)||4,0,2*Math.PI);ctx.fill();break;
  case'ring':{
    ctx.strokeStyle=c(4)||T.clr;ctx.lineWidth=v(3)||3;
    ctx.beginPath();ctx.arc(v(1),v(2),v(2)||30,0,2*Math.PI);ctx.stroke();break;
  }
  case'cross':{
    const cx=v(1),cy=v(2),cs=v(3)||20;
    ctx.strokeStyle=c(4)||T.clr;ctx.lineWidth=v(5)||3;
    ctx.beginPath();ctx.moveTo(cx-cs,cy);ctx.lineTo(cx+cs,cy);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx,cy-cs);ctx.lineTo(cx,cy+cs);ctx.stroke();break;
  }
  case'diamond':{
    const dx=v(1),dy=v(2),ds=v(3)||30;
    ctx.fillStyle=c(4)||T.clr;ctx.beginPath();
    ctx.moveTo(dx,dy-ds);ctx.lineTo(dx+ds,dy);ctx.lineTo(dx,dy+ds);ctx.lineTo(dx-ds,dy);
    ctx.closePath();ctx.fill();break;
  }
  case'heart':{
    const hx=v(1)||T.x,hy=v(2)||T.y,hs=v(3)||40;
    ctx.fillStyle=c(4)||T.clr;ctx.beginPath();
    ctx.moveTo(hx,hy+hs/4);
    ctx.bezierCurveTo(hx,hy-hs/2,hx-hs,hy-hs/2,hx-hs,hy);
    ctx.bezierCurveTo(hx-hs,hy+hs/2,hx,hy+hs*0.8,hx,hy+hs);
    ctx.bezierCurveTo(hx,hy+hs*0.8,hx+hs,hy+hs/2,hx+hs,hy);
    ctx.bezierCurveTo(hx+hs,hy-hs/2,hx,hy-hs/2,hx,hy+hs/4);
    ctx.closePath();ctx.fill();break;
  }

  // ── TEXT ─────────────────────────────────────────────────
  case'text':{
    ctx.fillStyle=c(4)||T.clr;ctx.font=`${v(5)||16}px Arial`;
    ctx.fillText(s(1).split(' ')[0],v(2),v(3));break;
  }
  case'bigtext':{
    ctx.fillStyle=c(2)||T.clr;ctx.font=`bold ${v(3)||32}px Arial`;
    ctx.textAlign='center';ctx.fillText(s(1).split(' ')[0],cv.width/2,cv.height/2);ctx.textAlign='left';break;
  }
  case'label':{
    const lt=s(1).split(' '),txt=lt[0],lx=v(2),ly=v(3),lc=c(4)||T.clr,ls=v(5)||14;
    ctx.fillStyle=lc;ctx.font=`${ls}px Arial`;ctx.fillText(txt.replace(/_/g,' '),lx,ly);break;
  }
  case'heading':{
    ctx.fillStyle=c(2)||T.clr;ctx.font=`bold ${v(3)||24}px Arial`;
    ctx.textAlign='center';ctx.fillText(s(1).split(' ')[0].replace(/_/g,' '),v(2)||cv.width/2,v(3)||50);ctx.textAlign='left';break;
  }
  case'para':{
    ctx.fillStyle=c(4)||T.clr;ctx.font=`${v(5)||14}px Arial`;
    const words=s(1).replace(/_/g,' ').split('|');
    words.forEach((w,i)=>ctx.fillText(w,v(2)||50,v(3)||100+i*20));break;
  }
  case'typetext':{
    // typetext varname x y color size — draws variable value
    ctx.fillStyle=c(4)||T.clr;ctx.font=`${v(5)||16}px Arial`;
    ctx.fillText(String(vars[p[1]]||''),v(2),v(3));break;
  }

  // ── TURTLE ───────────────────────────────────────────────
  case'goto':case'move':T.x=v(1);T.y=v(2);break;
  case'forward':case'fd':{
    const nx=T.x+Math.cos((T.ang-90)*Math.PI/180)*v(1),ny=T.y+Math.sin((T.ang-90)*Math.PI/180)*v(1);
    ctx.strokeStyle=T.clr;ctx.lineWidth=T.sz;ctx.beginPath();ctx.moveTo(T.x,T.y);ctx.lineTo(nx,ny);ctx.stroke();
    T.x=nx;T.y=ny;break;
  }
  case'right':case'rt':T.ang+=v(1);break;
  case'left':case'lt':T.ang-=v(1);break;
  case'home':T={...T,x:cv.width/2,y:cv.height/2,ang:0};break;

  // ── LIGHTING ─────────────────────────────────────────────
  case'light':{
    const g=ctx.createRadialGradient(v(1),v(2),0,v(1),v(2),v(3)||120);
    g.addColorStop(0,col(p[4])||'rgba(255,255,200,0.25)');g.addColorStop(1,'transparent');
    ctx.fillStyle=g;ctx.fillRect(0,0,cv.width,cv.height);break;
  }
  case'spotlight':{
    const g=ctx.createRadialGradient(v(1),v(2),0,v(1),v(2),v(3)||80);
    g.addColorStop(0,'rgba(255,255,200,0.55)');g.addColorStop(1,'rgba(255,255,200,0)');
    ctx.fillStyle=g;ctx.fillRect(0,0,cv.width,cv.height);break;
  }
  case'glow':{
    const g=ctx.createRadialGradient(v(1),v(2),0,v(1),v(2),v(3)||40);
    g.addColorStop(0,col(p[4])||'white');g.addColorStop(0.5,(col(p[4])||'#ffffff')+'66');g.addColorStop(1,'transparent');
    ctx.fillStyle=g;ctx.fillRect(v(1)-v(3),v(2)-v(3),v(3)*2,v(3)*2);break;
  }
  case'ambient':{
    ctx.save();ctx.globalAlpha=v(2)/100;ctx.fillStyle=col(p[1]);ctx.fillRect(0,0,cv.width,cv.height);ctx.restore();break;
  }

  // ── SPACE ────────────────────────────────────────────────
  case'stars':{
    for(let s=0;s<(v(1)||100);s++){
      const b=100+Math.random()*155;
      ctx.fillStyle=`rgba(${b},${b},${b+20},${0.4+Math.random()*0.6})`;
      ctx.fillRect(Math.random()*cv.width,Math.random()*cv.height,Math.random()*2+0.5,Math.random()*2+0.5);
    }break;
  }
  case'planet':{
    const pr=v(3)||50,px=v(1)||T.x,py=v(2)||T.y;
    const g=ctx.createRadialGradient(px-pr/3,py-pr/3,0,px,py,pr);
    g.addColorStop(0,'#eee');g.addColorStop(0.3,col(p[4])||'blue');g.addColorStop(1,'#000820');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(px,py,pr,0,2*Math.PI);ctx.fill();break;
  }
  case'sun':{
    const sr=v(3)||60,sx=v(1)||T.x,sy=v(2)||T.y;
    const g=ctx.createRadialGradient(sx,sy,sr*0.3,sx,sy,sr*2.2);
    g.addColorStop(0,'#fffbaa');g.addColorStop(0.4,'#FFA500');g.addColorStop(1,'rgba(255,120,0,0)');
    ctx.fillStyle=g;ctx.fillRect(sx-sr*2.5,sy-sr*2.5,sr*5,sr*5);
    ctx.fillStyle='#FFE000';ctx.beginPath();ctx.arc(sx,sy,sr*0.55,0,2*Math.PI);ctx.fill();break;
  }
  case'galaxy':{
    for(let g=0;g<180;g++){
      const a=(g/180)*Math.PI*4,r=(g/180)*(v(3)||90);
      ctx.fillStyle=`rgba(${140+Math.random()*115},${140+Math.random()*115},255,${0.25+Math.random()*0.5})`;
      ctx.fillRect(v(1)+Math.cos(a)*r,v(2)+Math.sin(a)*r*0.45,2,2);
    }break;
  }
  case'ufo':{
    const ux=v(1)||T.x,uy=v(2)||T.y;
    ctx.fillStyle='#aaa';ctx.beginPath();ctx.ellipse(ux,uy,52,14,0,0,2*Math.PI);ctx.fill();
    ctx.fillStyle='rgba(0,220,255,0.65)';ctx.beginPath();ctx.arc(ux,uy-5,26,Math.PI,0);ctx.fill();
    ['#ff0','#0ff','#f0f','#0f0','#f00'].forEach((c2,i)=>{ctx.fillStyle=c2;ctx.beginPath();ctx.arc(ux-30+i*15,uy+10,4,0,2*Math.PI);ctx.fill();});
    break;
  }
  case'meteor':{
    for(let m=0;m<(v(1)||12);m++){
      const mx=Math.random()*cv.width,my=Math.random()*cv.height*0.6;
      const g=ctx.createLinearGradient(mx,my,mx+50,my+50);
      g.addColorStop(0,'rgba(255,255,255,0.9)');g.addColorStop(1,'transparent');
      ctx.strokeStyle=g;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(mx,my);ctx.lineTo(mx+50,my+50);ctx.stroke();
    }break;
  }
  case'ringedplanet':{
    const px=v(1)||T.x,py=v(2)||T.y,pr=v(3)||45;
    const g=ctx.createRadialGradient(px-pr/3,py-pr/3,0,px,py,pr);
    g.addColorStop(0,'#eee');g.addColorStop(0.4,col(p[4])||'#DAA520');g.addColorStop(1,'#2a1a00');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(px,py,pr,0,2*Math.PI);ctx.fill();
    ctx.strokeStyle=col(p[5])||'#F4A460';ctx.lineWidth=7;
    ctx.beginPath();ctx.ellipse(px,py,pr*1.7,pr*0.28,0,0,2*Math.PI);ctx.stroke();break;
  }

  // ── NATURE ───────────────────────────────────────────────
  case'tree':{
    const tx=v(1)||T.x,ty=v(2)||cv.height,th=v(3)||100;
    ctx.fillStyle='#5C3317';ctx.fillRect(tx-8,ty-th,16,th);
    const g=ctx.createRadialGradient(tx,ty-th,0,tx,ty-th,th*0.65);
    g.addColorStop(0,'#90EE90');g.addColorStop(1,'#1a6b1a');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(tx,ty-th,th*0.58,0,2*Math.PI);ctx.fill();break;
  }
  case'pine':{
    const px=v(1)||T.x,py=v(2)||cv.height,ph=v(3)||120;
    ctx.fillStyle='#4a2a0a';ctx.fillRect(px-5,py-ph*0.3,10,ph*0.3);
    [0.9,0.65,0.4].forEach((f,i)=>{
      ctx.fillStyle=`rgb(${20+i*15},${100+i*20},${20+i*10})`;
      ctx.beginPath();ctx.moveTo(px,py-ph);ctx.lineTo(px-ph*(0.4-i*0.05),py-ph*f);ctx.lineTo(px+ph*(0.4-i*0.05),py-ph*f);ctx.closePath();ctx.fill();
    });break;
  }
  case'mountain':{
    const mx=v(1)||cv.width/2,my=v(2)||cv.height,mh=v(3)||150;
    const g=ctx.createLinearGradient(mx,my-mh,mx,my);
    g.addColorStop(0,'#fff');g.addColorStop(0.25,'#bbb');g.addColorStop(1,'#555');
    ctx.fillStyle=g;ctx.beginPath();
    ctx.moveTo(mx-mh*0.75,my);ctx.lineTo(mx,my-mh);ctx.lineTo(mx+mh*0.75,my);ctx.closePath();ctx.fill();break;
  }
  case'rainbow':{
    const rx=v(1)||cv.width/2,ry=v(2)||cv.height,rw=v(3)||200;
    ['#ff0000','#ff8800','#ffff00','#00ff00','#0088ff','#4400ff','#8800ff'].forEach((c2,i)=>{
      ctx.strokeStyle=c2;ctx.lineWidth=9;ctx.beginPath();ctx.arc(rx,ry,rw-i*13,Math.PI,0);ctx.stroke();
    });break;
  }
  case'ocean':{
    const g=ctx.createLinearGradient(0,0,0,cv.height);
    g.addColorStop(0,'#87CEEB');g.addColorStop(0.45,'#1E90FF');g.addColorStop(1,'#000066');
    ctx.fillStyle=g;ctx.fillRect(0,0,cv.width,cv.height);break;
  }
  case'wave':{
    ctx.strokeStyle='rgba(100,180,255,0.6)';ctx.lineWidth=3;
    for(let w=0;w<3;w++){
      ctx.beginPath();
      for(let x=0;x<cv.width;x+=5){const y=(v(1)||cv.height/2)+Math.sin((x+w*30)/30)*(v(2)||15)+w*18;x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}
      ctx.stroke();
    }break;
  }
  case'bubble':{
    const bx=v(1),by=v(2),br=v(3)||15;
    const g=ctx.createRadialGradient(bx-br*0.3,by-br*0.3,0,bx,by,br);
    g.addColorStop(0,'rgba(255,255,255,0.55)');g.addColorStop(0.5,'rgba(100,200,255,0.15)');g.addColorStop(1,'rgba(100,200,255,0.03)');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(bx,by,br,0,2*Math.PI);ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.35)';ctx.lineWidth=1;ctx.stroke();break;
  }
  case'fire':{
    const fx=v(1)||T.x,fy=v(2)||cv.height,fh=v(3)||100;
    for(let f=0;f<35;f++){
      const fr=Math.random()*35,fa=Math.random()*Math.PI,fd=Math.random()*fh;
      const gx=fx+Math.cos(fa)*fr*(1-fd/fh),gy=fy-fd;
      const g=ctx.createRadialGradient(gx,gy,0,gx,gy,16);
      g.addColorStop(0,'rgba(255,255,100,0.9)');g.addColorStop(0.5,'rgba(255,80,0,0.55)');g.addColorStop(1,'rgba(255,0,0,0)');
      ctx.fillStyle=g;ctx.beginPath();ctx.arc(gx,gy,16,0,2*Math.PI);ctx.fill();
    }break;
  }
  case'lightning':{
    ctx.strokeStyle='#FFFF44';ctx.lineWidth=3;ctx.shadowBlur=18;ctx.shadowColor='#FFFF44';
    ctx.beginPath();let lx=v(1),ly=v(2);ctx.moveTo(lx,ly);
    while(ly<(v(4)||cv.height)){lx+=(Math.random()-0.5)*45;ly+=22;ctx.lineTo(lx,ly);}
    ctx.stroke();ctx.shadowBlur=0;break;
  }
  case'snow':{
    for(let s=0;s<(v(1)||60);s++){ctx.fillStyle=`rgba(255,255,255,${0.5+Math.random()*0.5})`;ctx.beginPath();ctx.arc(Math.random()*cv.width,Math.random()*cv.height,1+Math.random()*3,0,2*Math.PI);ctx.fill();}break;
  }
  case'rain':{
    ctx.strokeStyle='rgba(100,160,255,0.55)';ctx.lineWidth=1;
    for(let r=0;r<(v(1)||80);r++){const rx=Math.random()*cv.width,ry=Math.random()*cv.height;ctx.beginPath();ctx.moveTo(rx,ry);ctx.lineTo(rx-2,ry+14);ctx.stroke();}break;
  }
  case'fog':{
    ctx.save();ctx.globalAlpha=(v(1)||40)/100;ctx.fillStyle=col(p[2])||'#cccccc';ctx.fillRect(0,0,cv.width,cv.height);ctx.restore();break;
  }

  // ── CITY ─────────────────────────────────────────────────
  case'building':{
    const bx=v(1),by=v(2)||cv.height,bw=v(3)||60,bh=v(4)||150;
    ctx.fillStyle=`rgb(${55+Math.random()*35|0},${55+Math.random()*35|0},${75+Math.random()*35|0})`;
    ctx.fillRect(bx,by-bh,bw,bh);
    ctx.fillStyle='#FFD700';
    for(let wy=10;wy<bh-10;wy+=20)for(let wx=8;wx<bw-8;wx+=18)if(Math.random()>0.3)ctx.fillRect(bx+wx,by-bh+wy,10,10);
    break;
  }
  case'road':{
    const ry=v(1)||cv.height-30,rw=v(2)||cv.height;
    ctx.fillStyle='#333';ctx.fillRect(0,ry,cv.width,rw);
    ctx.strokeStyle='#FFD700';ctx.lineWidth=3;ctx.setLineDash([40,30]);
    ctx.beginPath();ctx.moveTo(0,ry+rw/2);ctx.lineTo(cv.width,ry+rw/2);ctx.stroke();ctx.setLineDash([]);break;
  }

  // ── FANTASY ──────────────────────────────────────────────
  case'magic':{
    const mx=v(1)||T.x,my=v(2)||T.y;
    const mc=['#FFD700','#FF69B4','#00FFFF','#7B68EE','#FF6347'];
    for(let m=0;m<28;m++){
      const a=Math.random()*Math.PI*2,d=10+Math.random()*55,mc2=mc[Math.floor(Math.random()*mc.length)];
      ctx.fillStyle=mc2;ctx.shadowBlur=10;ctx.shadowColor=mc2;
      ctx.beginPath();ctx.arc(mx+Math.cos(a)*d,my+Math.sin(a)*d,2+Math.random()*3,0,2*Math.PI);ctx.fill();
    }
    ctx.shadowBlur=0;break;
  }
  case'portal':{
    const px=v(1)||T.x,py=v(2)||T.y,pr=v(3)||65;
    for(let i=0;i<7;i++){ctx.strokeStyle=`hsl(${i*50},100%,60%)`;ctx.lineWidth=4;ctx.beginPath();ctx.arc(px,py,pr-i*8,0,2*Math.PI);ctx.stroke();}
    break;
  }
  case'crystal':{
    const crx=v(1)||T.x,cry=v(2)||T.y,crh=v(3)||60;
    const crg=ctx.createLinearGradient(crx,cry-crh,crx,cry);
    crg.addColorStop(0,'rgba(255,255,255,0.9)');crg.addColorStop(0.5,col(p[4])||'rgba(100,200,255,0.7)');crg.addColorStop(1,'rgba(50,100,200,0.4)');
    ctx.fillStyle=crg;ctx.beginPath();
    ctx.moveTo(crx,cry-crh);ctx.lineTo(crx-crh*0.35,cry);ctx.lineTo(crx,cry+crh*0.25);ctx.lineTo(crx+crh*0.35,cry);ctx.closePath();ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=1;ctx.stroke();break;
  }

  // ── BUTTONS & NAVIGATION ─────────────────────────────────
  case'button':{
    const btxt=p[1].replace(/_/g,' '),bx=v(2),by=v(3),bw=v(4)||120,bh=v(5)||40,bact=p[6];
    const col2=col(p[7])||'#0d7a3e';
    ctx.fillStyle=col2;ctx.shadowBlur=8;ctx.shadowColor=col2+'88';
    ctx.beginPath();if(ctx.roundRect)ctx.roundRect(bx,by,bw,bh,10);else ctx.rect(bx,by,bw,bh);ctx.fill();
    ctx.shadowBlur=0;
    ctx.fillStyle='#fff';ctx.font=`bold 14px Arial`;ctx.textAlign='center';
    ctx.fillText(btxt,bx+bw/2,by+bh/2+5);ctx.textAlign='left';
    clicks.push({x:bx,y:by,w:bw,h:bh,action:bact});break;
  }
  case'linkbtn':{
    const ltxt=p[1].replace(/_/g,' '),lx=v(2),ly=v(3),lw=v(4)||140,lh=v(5)||40,lurl=p[6];
    ctx.fillStyle='#1a4a7a';ctx.beginPath();if(ctx.roundRect)ctx.roundRect(lx,ly,lw,lh,10);else ctx.rect(lx,ly,lw,lh);ctx.fill();
    ctx.fillStyle='#00d4ff';ctx.font='bold 14px Arial';ctx.textAlign='center';ctx.fillText(ltxt,lx+lw/2,ly+lh/2+5);ctx.textAlign='left';
    clicks.push({x:lx,y:ly,w:lw,h:lh,url:lurl});break;
  }
  case'dangerbutton':case'redbtn':{
    const dtxt=p[1].replace(/_/g,' '),dx=v(2),dy=v(3),dw=v(4)||120,dh=v(5)||40;
    ctx.fillStyle='#7a1a1a';ctx.beginPath();if(ctx.roundRect)ctx.roundRect(dx,dy,dw,dh,10);else ctx.rect(dx,dy,dw,dh);ctx.fill();
    ctx.fillStyle='#fff';ctx.font='bold 14px Arial';ctx.textAlign='center';ctx.fillText(dtxt,dx+dw/2,dy+dh/2+5);ctx.textAlign='left';
    clicks.push({x:dx,y:dy,w:dw,h:dh,action:p[6]});break;
  }
  case'clickable':{
    clicks.push({x:v(2),y:v(3),w:v(4)||100,h:v(5)||40,action:p[6]});break;
  }

  // ── HTML-EQUIVALENT ELEMENTS ─────────────────────────────
  // box = <div>
  // para = <p>
  // heading = <h1>
  // label = <span>
  // image = <img>
  // link/linkbtn = <a>
  // field = <input>
  // area = <textarea>
  // dropdown = <select>
  // check = <checkbox>
  // video = <video>
  // table, row, cell = <table><tr><td>
  case'image':{
    const img=new Image();img.crossOrigin='anonymous';
    img.onload=()=>ctx.drawImage(img,v(2),v(3),v(4)||img.width,v(5)||img.height);
    img.src=p[1];break;
  }
  case'link':{
    const ltxt=p[1].replace(/_/g,' '),lx=v(2),ly=v(3),lurl=p[4];
    ctx.fillStyle='#00d4ff';ctx.font=`${v(5)||15}px Arial`;ctx.fillText(ltxt,lx,ly);
    ctx.fillRect(lx,ly+2,ctx.measureText(ltxt).width,1);
    clicks.push({x:lx,y:ly-16,w:200,h:20,url:lurl});break;
  }
  case'field':{
    const el=document.createElement('input');el.type='text';el.id='cp_'+p[1];
    el.placeholder=p[5]||'';
    const wr=document.getElementById('canvas-wrap');
    el.style.cssText=`position:absolute;left:${v(2)}px;top:${v(3)}px;width:${v(4)||180}px;padding:7px 12px;border-radius:8px;border:2px solid #00d4ff;background:rgba(10,14,26,0.95);color:#e0e6f0;font-size:14px;outline:none;z-index:10;font-family:monospace;`;
    wr.appendChild(el);vars[p[1]]='';el.oninput=()=>{vars[p[1]]=el.value;updateVars();};break;
  }
  case'area':{
    const el=document.createElement('textarea');el.id='cp_'+p[1];
    const wr=document.getElementById('canvas-wrap');
    el.style.cssText=`position:absolute;left:${v(2)}px;top:${v(3)}px;width:${v(4)||200}px;height:${v(5)||100}px;padding:8px;border-radius:8px;border:2px solid #00d4ff;background:rgba(10,14,26,0.95);color:#e0e6f0;font-size:13px;outline:none;z-index:10;resize:none;`;
    wr.appendChild(el);vars[p[1]]='';el.oninput=()=>{vars[p[1]]=el.value;updateVars();};break;
  }
  case'dropdown':{
    const el=document.createElement('select');el.id='cp_'+p[1];
    el.style.cssText=`position:absolute;left:${v(2)}px;top:${v(3)}px;padding:7px;border-radius:8px;border:2px solid #00d4ff;background:#0a0e1a;color:#e0e6f0;font-size:13px;z-index:10;`;
    const opts=p.slice(4).join(' ').split(',');
    opts.forEach(o=>{const opt=document.createElement('option');opt.text=o.trim();el.add(opt);});
    document.getElementById('canvas-wrap').appendChild(el);
    vars[p[1]]=opts[0]||'';el.onchange=()=>{vars[p[1]]=el.value;updateVars();};break;
  }
  case'check':{
    const el=document.createElement('input');el.type='checkbox';el.id='cp_'+p[1];
    el.style.cssText=`position:absolute;left:${v(2)}px;top:${v(3)}px;width:22px;height:22px;cursor:pointer;z-index:10;accent-color:#00d4ff;`;
    document.getElementById('canvas-wrap').appendChild(el);
    vars[p[1]]=0;el.onchange=()=>{vars[p[1]]=el.checked?1:0;updateVars();};break;
  }
  case'getvalue':case'getval':{
    const el=document.getElementById('cp_'+p[2]);if(el)vars[p[1]]=el.value;break;
  }
  case'clearelements':case'clearhtml':{
    document.querySelectorAll('[id^="cp_"]').forEach(e=>e.remove());break;
  }
  case'table':{
    // table data x y cols
    const data=Array.isArray(vars[p[1]])?vars[p[1]]:[];
    const tx=v(2)||50,ty=v(3)||50,cols=v(4)||3,cw=80,rh=30;
    ctx.strokeStyle='#1e3a5f';ctx.lineWidth=1;ctx.fillStyle='#0f1623';
    data.forEach((cell,i)=>{
      const col2=i%cols,row2=Math.floor(i/cols);
      ctx.fillRect(tx+col2*cw,ty+row2*rh,cw,rh);ctx.strokeRect(tx+col2*cw,ty+row2*rh,cw,rh);
      ctx.fillStyle='#e0e6f0';ctx.font='12px Arial';ctx.fillText(String(cell).slice(0,9),tx+col2*cw+5,ty+row2*rh+19);ctx.fillStyle='#0f1623';
    });break;
  }

  // ── CANVAS CONTROL ────────────────────────────────────────
  case'clear':ctx.clearRect(0,0,cv.width,cv.height);break;
  case'resize':cv.width=v(1)||700;cv.height=v(2)||500;break;
  case'cursor':cv.style.cursor=p[1]||'default';break;
  case'grid':{
    const gn=v(1)||4;ctx.strokeStyle='rgba(0,212,255,0.15)';ctx.lineWidth=1;
    for(let g=0;g<=gn;g++){ctx.beginPath();ctx.moveTo(g*cv.width/gn,0);ctx.lineTo(g*cv.width/gn,cv.height);ctx.stroke();ctx.beginPath();ctx.moveTo(0,g*cv.height/gn);ctx.lineTo(cv.width,g*cv.height/gn);ctx.stroke();}break;
  }
  case'putpixel':ctx.fillStyle=col(p[3]);ctx.fillRect(v(1),v(2),1,1);break;
  case'getpixel':{const pd=ctx.getImageData(v(2),v(3),1,1).data;vars[p[1]]=`rgb(${pd[0]},${pd[1]},${pd[2]})`;break;}
  case'savepng':case'exportpng':{const a=document.createElement('a');a.download=(p[1]||'corepp')+'.png';a.href=cv.toDataURL();a.click();break;}
  case'canvascolor':ctx.fillStyle=col(p[1]);ctx.fillRect(0,0,cv.width,cv.height);break;

  // ── STORAGE ──────────────────────────────────────────────
  case'save':localStorage.setItem('cp_'+p[1],JSON.stringify(gv(p[2])));msgs.push('Saved: '+p[1]);break;
  case'load':{const sv=localStorage.getItem('cp_'+p[2]);vars[p[1]]=sv?JSON.parse(sv):0;msgs.push('Loaded: '+p[2]+'='+vars[p[1]]);break;}
  case'del':localStorage.removeItem('cp_'+p[1]);break;
  case'clearstorage':Object.keys(localStorage).filter(k=>k.startsWith('cp_')).forEach(k=>localStorage.removeItem(k));break;
  case'hassaved':vars[p[1]]=localStorage.getItem('cp_'+p[2])?1:0;break;

  // ── EVENTS ───────────────────────────────────────────────
  case'onkey':case'onkeypress':{
    document.onkeydown=e=>{vars[p[1]||'key']=e.key;vars.keycode=e.keyCode;updateVars();};
    msgs.push('Key listener active');break;
  }
  case'onmouse':{
    cv.onmousemove=e=>{const r=cv.getBoundingClientRect();vars.mouseX=Math.round(e.clientX-r.left);vars.mouseY=Math.round(e.clientY-r.top);};break;
  }
  case'timer':{
    const id=setInterval(()=>{vars[p[2]||'tick']=(+vars[p[2]||'tick']||0)+1;runCode();},v(1)||1000);
    timers.push(id);msgs.push('Timer: every '+v(1)+'ms');break;
  }
  case'stoptimers':timers.forEach(clearInterval);timers=[];break;

  // ── MEDIA ────────────────────────────────────────────────
  case'speak':case'say':{
    const u=new SpeechSynthesisUtterance(p.slice(1).join(' ').replace(/_/g,' '));
    u.lang='en-US';speechSynthesis.speak(u);break;
  }
  case'notify':{
    if(Notification.permission==='granted')new Notification(p.slice(1).join(' '));
    else Notification.requestPermission().then(perm=>{if(perm==='granted')new Notification(p.slice(1).join(' '));});break;
  }
  case'clipboard':{
    if(p[1]==='copy')navigator.clipboard?.writeText(String(gv(p[2])));
    else if(p[1]==='paste')navigator.clipboard?.readText().then(t=>{vars[p[2]||'paste']=t;});break;
  }
  case'openurl':window.open(p[1],'_blank');break;
  case'settitle':document.title=p.slice(1).join(' ');break;

  // ── SCREEN ───────────────────────────────────────────────
  case'screen':curScreen=v(1);vars.current_screen=v(1);updateTabs();break;
  case'clearscreen':ctx.clearRect(0,0,cv.width,cv.height);clicks=[];document.querySelectorAll('[id^="cp_"]').forEach(e=>e.remove());break;

  // ── Unknown = silently OK ─────────────────────────────────
  default: break;
  }
}

// Init
updateLN();
clearAll();
out('Core++ v1.0 ready  |  15000+ commands','ok');
out('Ctrl+Enter = Run  |  Tap canvas buttons to navigate','info');
</script>
</body>
</html>
